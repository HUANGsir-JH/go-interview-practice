{{define "content"}}
<style>
.editor-fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    background: white !important;
    padding: 20px !important;
}

.editor-fullscreen .editor-container {
    height: calc(100vh - 80px) !important;
}

.editor-toolbar {
    transition: all 0.2s ease;
}

.editor-toolbar:hover {
    background: rgba(255,255,255,1) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Editor Status Bar Styling */
.editor-status-bar {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
    transition: all 0.2s ease;
}

.editor-status-bar:hover {
    background: rgba(248,249,250,1) !important;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
}

/* Custom Tooltip Styling */
.tooltip {
    z-index: 10001 !important; /* Above editor toolbar */
}

.tooltip .tooltip-inner {
    background-color: #ffffff !important;
    color: #212529 !important;
    border: 1px solid #dee2e6 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    font-size: 12px !important;
    padding: 8px 12px !important;
    border-radius: 6px !important;
    font-weight: 500 !important;
}

.tooltip .tooltip-arrow::before {
    border-top-color: #ffffff !important;
    border-bottom-color: #ffffff !important;
    border-left-color: #ffffff !important;
    border-right-color: #ffffff !important;
}

.tooltip.bs-tooltip-bottom .tooltip-arrow::before {
    border-bottom-color: #ffffff !important;
}

.tooltip.bs-tooltip-top .tooltip-arrow::before {
    border-top-color: #ffffff !important;
}

.tooltip.bs-tooltip-end .tooltip-arrow::before {
    border-right-color: #ffffff !important;
}

.tooltip.bs-tooltip-start .tooltip-arrow::before {
    border-left-color: #ffffff !important;
}

/* Spinning animation for reset button */
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Ensure toasts appear above editor */
.toast-container {
    z-index: 10000 !important;
}

/* Enhanced Editor Button Styling */
#reset-editor-btn, #fullscreen-btn {
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#reset-editor-btn:hover, #fullscreen-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.25);
}

#reset-editor-btn:active, #fullscreen-btn:active {
    transform: translateY(0);
}

#reset-editor-btn:disabled, #fullscreen-btn:disabled {
    transform: none;
    cursor: not-allowed;
    opacity: 0.6;
}

#reset-editor-btn::before, #fullscreen-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

#reset-editor-btn:hover::before, #fullscreen-btn:hover::before {
    left: 100%;
}

/* Custom reset modal styling */
.reset-modal .modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

.reset-modal .modal-header {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    border-radius: 12px 12px 0 0;
    border-bottom: none;
}

.reset-modal .modal-title {
    font-weight: 600;
}

.reset-modal .btn-close {
    filter: invert(1);
}

.reset-modal .code-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 12px;
    max-height: 120px;
    overflow-y: auto;
}

.reset-modal .btn-reset-confirm {
    background: linear-gradient(135deg, #dc3545, #c82333);
    border: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.reset-modal .btn-reset-confirm:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}
</style>
<!-- Debug info: Template and TestFile content should be loaded below -->
<!-- Hidden elements to store content safely -->
<script type="text/plain" id="template-content">{{.Challenge.Template}}</script>
<script type="text/plain" id="testfile-content">{{.Challenge.TestFile}}</script>
<script type="text/plain" id="learning-content">{{.Challenge.LearningMaterials}}</script>
<script type="text/plain" id="hints-content">{{.Challenge.Hints}}</script>
<script type="text/plain" id="has-attempted">{{if .HasAttempted}}true{{else}}false{{end}}</script>
<script type="text/plain" id="existing-solution">{{.ExistingSolution}}</script>


<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">æŒ‘æˆ˜</a></li>
                <li class="breadcrumb-item"><a href="/packages/{{.Package.Name}}">{{.Package.DisplayName}}</a></li>
                <li class="breadcrumb-item active">{{.Challenge.Title}}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{.Package.DisplayName}}: {{.Challenge.Title}}</h5>
                <span class="badge bg-primary badge-{{.Challenge.Difficulty | lower}}">{{.Challenge.Difficulty}}</span>
            </div>
            <div class="card-body">
                {{if .HasAttempted}}
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle-fill"></i> æ‚¨ä¹‹å‰å·²å°è¯•è¿‡æ­¤æŒ‘æˆ˜ã€‚
                    {{if .ExistingSolution}}
                    <br>æ‚¨çš„ç°æœ‰è§£å†³æ–¹æ¡ˆå·²åœ¨ç¼–è¾‘å™¨ä¸­åŠ è½½ã€‚
                    {{end}}
                </div>
                {{end}}
                
                <div class="markdown-content" id="challenge-description">
                    {{.Challenge.Description | markdown}}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="editorTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="solution-tab" data-bs-toggle="tab" href="#solution" role="tab">è§£å†³æ–¹æ¡ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tests-tab" data-bs-toggle="tab" href="#tests" role="tab">æµ‹è¯•</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="results-tab" data-bs-toggle="tab" href="#results" role="tab">ç»“æœ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="hints-tab" data-bs-toggle="tab" href="#hints" role="tab">
                            <i class="bi bi-lightbulb me-1"></i>æç¤º
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="learning-tab" data-bs-toggle="tab" href="#learning" role="tab">å­¦ä¹ </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="solution" role="tabpanel">
                                                    <div class="editor-wrapper position-relative">
                            <!-- ç¼–è¾‘å™¨å·¥å…·æ  -->
                            <div class="editor-toolbar position-absolute top-0 end-0 p-2 d-flex align-items-center gap-2" style="z-index: 10; background: rgba(255,255,255,0.95); border-radius: 0 0 0 8px; border-left: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;">
                                <!-- ä¿å­˜çŠ¶æ€ -->
                                <span id="save-indicator" class="badge bg-success d-none">
                                    <i class="bi bi-check2"></i> å·²ä¿å­˜
                                </span>
                                <span id="saving-indicator" class="badge bg-warning d-none">
                                    <i class="bi bi-arrow-repeat"></i> æ­£åœ¨ä¿å­˜...
                                </span>

                                <!-- å…¨å±æŒ‰é’® -->
                                <button class="btn btn-outline-primary btn-sm" id="fullscreen-btn" 
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="è¿›å…¥å…¨å±æ¨¡å¼ (ESC é€€å‡º)">
                                    <i class="bi bi-arrows-fullscreen"></i>
                                </button>

                                <!-- é‡ç½®æŒ‰é’® -->
                                <button class="btn btn-outline-primary btn-sm" id="reset-editor-btn" 
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="å°†ä»£ç é‡ç½®ä¸ºåŸå§‹æ¨¡æ¿">
                                    <span id="reset-icon">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </span>
                                    <span id="reset-spinner" class="d-none">
                                        <i class="bi bi-arrow-repeat spin"></i>
                                    </span>
                                </button>
                            </div>

                            <!-- ç¼–è¾‘å™¨çŠ¶æ€æ  -->
                            <div class="editor-status-bar position-absolute bottom-0 end-0 px-2 py-1" style="z-index: 10; background: rgba(248,249,250,0.95); border-radius: 4px 0 0 0; border-left: 1px solid #dee2e6; border-top: 1px solid #dee2e6;">
                                <small class="text-muted" id="editor-position">
                                    <i class="bi bi-cursor-text me-1"></i>
                                    ç¬¬ <span id="line-number">1</span> è¡Œï¼Œç¬¬ <span id="col-number">1</span> åˆ—
                                </small>
                            </div>

                            <div id="editor" class="editor-container"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tests" role="tabpanel">
                        <div id="test-editor" class="editor-container"></div>
                    </div>
                    <div class="tab-pane fade" id="results" role="tabpanel">
                        <div id="test-results" class="p-3">
                            <div class="alert alert-info">è¿è¡Œæ‚¨çš„ä»£ç ä»¥æŸ¥çœ‹æµ‹è¯•ç»“æœã€‚</div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hints" role="tabpanel">
                        <div id="hints-content" class="p-3">
                            <div class="text-center mb-4">
                                <i class="bi bi-lightbulb" style="font-size: 2.5rem; color: #ffc107;"></i>
                                <h5 class="mb-2">é€æ­¥æç¤º</h5>
                                <p class="text-muted mb-3">ç‚¹å‡»â€œæ˜¾ç¤ºä¸‹ä¸€ä¸ªæç¤ºâ€é€ä¸ªæ­ç¤ºæç¤º</p>
                            </div>
                            
                            <div id="hints-container">
                                <!-- æç¤ºå°†åŠ¨æ€åŠ è½½äºæ­¤ -->
                            </div>
                            
                            <div class="text-center mt-4">
                                <button class="btn btn-outline-warning" id="show-hint-btn">
                                    <i class="bi bi-lightbulb me-2"></i>æ˜¾ç¤ºä¸‹ä¸€ä¸ªæç¤º
                                </button>
                                <button class="btn btn-outline-secondary ms-2 d-none" id="reset-hints-btn">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>é‡ç½®æç¤º
                                </button>
                            </div>
                            
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <span id="hints-progress">0</span> / <span id="total-hints">0</span> ä¸ªæç¤ºå·²æ­ç¤º
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="learning" role="tabpanel">
                        <div id="learning-materials" class="p-3 markdown-content">
                            <!-- å­¦ä¹ ææ–™å°†åœ¨æ­¤å¤„åŠ è½½ -->
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-primary" id="run-button">
                        <span class="spinner-border spinner-border-sm d-none" id="run-spinner" role="status" aria-hidden="true"></span>
                        <span id="run-text">è¿è¡Œæµ‹è¯•</span>
                    </button>
                    <button class="btn btn-success" id="submit-button">
                        <span class="spinner-border spinner-border-sm d-none" id="submit-spinner" role="status" aria-hidden="true"></span>
                        <span id="submit-text">æäº¤è§£å†³æ–¹æ¡ˆ</span>
                    </button>
                </div>
                
                <!-- çŠ¶æ€æ¶ˆæ¯æç¤ºæ¡† -->
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
                    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <strong class="me-auto" id="toast-title">é€šçŸ¥</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="å…³é—­"></button>
                        </div>
                        <div class="toast-body" id="toast-message">
                            æ¶ˆæ¯å†…å®¹
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä»˜è´¹èµåŠ©å•†éƒ¨åˆ† -->
<div class="row mb-4">
    <div class="col">
        <div class="text-center py-3">
            <div class="sponsors-container" id="package-challenge-premium-sponsors">
                <!-- ä»˜è´¹èµåŠ©å•†å›¾æ ‡å°†å‡ºç°åœ¨æ­¤å¤„ -->
                <div class="text-muted">
                    <i class="bi bi-building me-2"></i>
                    <span class="small">
                        <a href="https://github.com/sponsors/RezaSi" target="_blank" class="text-decoration-none text-muted">
                            ç”±æˆ‘ä»¬çš„é«˜çº§åˆä½œä¼™ä¼´èµåŠ©
                        </a>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é‡ç½®ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade reset-modal" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>å°†ä»£ç é‡ç½®ä¸ºåŸå§‹æ¨¡æ¿
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="mb-2"><strong>æ‚¨ç¡®å®šè¦é‡ç½®ä»£ç å—ï¼Ÿ</strong></p>
                    <p class="text-muted small mb-3">æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ›´æ”¹å¹¶æ¢å¤åŸå§‹æ¨¡æ¿ã€‚</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-danger mb-2">
                        <i class="bi bi-trash me-1"></i>å°†ä¸¢å¤±çš„å†…å®¹ï¼š
                    </h6>
                    <ul class="list-unstyled small text-muted mb-0">
                        <li><i class="bi bi-x-circle text-danger me-1"></i>æ‚¨å½“å‰çš„æ‰€æœ‰ä»£ç æ›´æ”¹</li>
                        <li><i class="bi bi-x-circle text-danger me-1"></i>æµè§ˆå™¨ä¸­çš„è‡ªåŠ¨ä¿å­˜è¿›åº¦</li>
                        <li><i class="bi bi-x-circle text-danger me-1"></i>è‡ªä¸Šæ¬¡æäº¤ä»¥æ¥çš„æ‰€æœ‰å·¥ä½œ</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <h6 class="text-success mb-2">
                        <i class="bi bi-arrow-clockwise me-1"></i>å°†æ¢å¤çš„å†…å®¹ï¼š
                    </h6>
                    <div class="code-preview p-2">
                        <div class="small text-muted mb-1">åŸå§‹æ¨¡æ¿é¢„è§ˆï¼š</div>
                        <pre id="template-preview" class="mb-0"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-danger btn-reset-confirm" id="confirmResetBtn">
                    <span id="confirm-reset-text">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>é‡ç½®ä»£ç 
                    </span>
                    <span id="confirm-reset-spinner" class="d-none">
                        <i class="bi bi-arrow-repeat spin me-1"></i>æ­£åœ¨é‡ç½®...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

{{end}}

{{define "scripts"}}
<script>
    // è¾…åŠ©å‡½æ•°ç”¨äºè§£ç HTMLå®ä½“
    function decodeHtmlEntities(text) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }

    // å…¨å±€æŒ‘æˆ˜æ•°æ®å˜é‡
    let challengeData = {};

    // ç”¨æˆ·æ•°æ®å’Œç°æœ‰è§£å†³æ–¹æ¡ˆ
    const hasAttempted = document.getElementById('has-attempted').textContent === 'true';
    const existingSolution = decodeHtmlEntities(document.getElementById('existing-solution').textContent) || null;

    document.addEventListener('DOMContentLoaded', function() {
        // å¦‚æœæœåŠ¡å™¨æä¾›ç”¨æˆ·åï¼Œåˆ™å­˜å‚¨åˆ° localStorage
        const serverUsername = '{{.Username}}';
        if (serverUsername && serverUsername !== '') {
            localStorage.setItem('githubUsername', serverUsername);
        }
        
        // ä»æœåŠ¡å™¨åˆå§‹åŒ–æŒ‘æˆ˜æ•°æ®ï¼ˆä»éšè—å…ƒç´ åŠ è½½ï¼‰
        challengeData = {
            packageName: "{{.Package.Name}}",
            challengeId: "{{.Challenge.ID}}", // ä¿æŒä¸ºå­—ç¬¦ä¸²ç”¨äºAPIè°ƒç”¨
            challengeIdForHighlighting: "{{.Package.Name}}_{{.Challenge.ID}}", // ç”¨äºé«˜äº®å­˜å‚¨çš„å”¯ä¸€å­—ç¬¦ä¸²
            title: "{{.Challenge.Title}}",
            description: `{{.Challenge.Description}}`,
            template: decodeHtmlEntities(document.getElementById('template-content').textContent),
            testFile: decodeHtmlEntities(document.getElementById('testfile-content').textContent),
            learningMaterials: decodeHtmlEntities(document.getElementById('learning-content').textContent),
            hints: decodeHtmlEntities(document.getElementById('hints-content').textContent)
        };
        // åˆå§‹åŒ– Markdown æ¸²æŸ“æè¿°ï¼ˆæè¿°å·²åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼‰
        // åªéœ€é«˜äº®æ¸²æŸ“å†…å®¹ä¸­çš„ä»£ç å—
        hljs.highlightAll();

        // åˆå§‹åŒ–å­¦ä¹ ææ–™çš„ Markdown æ¸²æŸ“
        const learningElement = document.getElementById('learning-materials');
        renderMarkdown(challengeData.learningMaterials, learningElement);

        // åˆå§‹åŒ–å­¦ä¹ ææ–™é«˜äº®
        initLearningMaterials('learning-materials', challengeData.challengeIdForHighlighting);

        // åˆå§‹åŒ–æç¤ºç³»ç»Ÿ
        initializeHints(challengeData.hints);

        // åˆå§‹åŒ–è§£å†³æ–¹æ¡ˆä»£ç ç¼–è¾‘å™¨
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/chrome");
        editor.session.setMode("ace/mode/golang");
        
        // ä»æ¨¡æ¿æˆ–ç°æœ‰è§£å†³æ–¹æ¡ˆåŠ è½½å†…å®¹
        if (existingSolution) {
            editor.setValue(existingSolution);
        } else {
            editor.setValue(challengeData.template);
        }
        
        editor.clearSelection();

        // åˆå§‹åŒ–æµ‹è¯•ä»£ç ç¼–è¾‘å™¨
        const testEditor = ace.edit("test-editor");
        testEditor.setTheme("ace/theme/chrome");
        testEditor.session.setMode("ace/mode/golang");
        testEditor.setValue(challengeData.testFile);
        testEditor.setReadOnly(true);
        testEditor.clearSelection();

        // æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('run-button').addEventListener('click', function() {
            runCode(false);
        });

        document.getElementById('submit-button').addEventListener('click', function() {
            runCode(true);
        });

        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½åŠè§†è§‰æŒ‡ç¤ºå™¨
        let saveTimeout;
        let isOriginalTemplate = true;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„ä»£ç ä»¥ç¡®å®šåˆå§‹çŠ¶æ€
        const savedCode = localStorage.getItem(`package_challenge_${challengeData.packageName}_${challengeData.challengeId}`);
        if (savedCode && !existingSolution) {
            editor.setValue(savedCode, 1);
            isOriginalTemplate = false;
            showSaveIndicator();
        }
        
                 editor.session.on('change', function() {
            clearTimeout(saveTimeout);
            isOriginalTemplate = false;

            // æ˜¾ç¤ºæ­£åœ¨ä¿å­˜æŒ‡ç¤ºå™¨
            showSavingIndicator();

            saveTimeout = setTimeout(() => {
                localStorage.setItem(`package_challenge_${challengeData.packageName}_${challengeData.challengeId}`, editor.getValue());
                showSaveIndicator();
            }, 1000);
        });

        // åœ¨å…‰æ ‡ç§»åŠ¨æ—¶æ›´æ–°è¡Œ/åˆ—å·
        editor.selection.on('changeCursor', function() {
            updateEditorPosition();
        });

        // åˆå§‹ä½ç½®æ›´æ–°
        updateEditorPosition();

        // åˆå§‹åŒ–å·¥å…·æç¤º
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // é‡ç½®æŒ‰é’®åŠŸèƒ½
        document.getElementById('reset-editor-btn').addEventListener('click', function() {
            // åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºæ¨¡æ¿é¢„è§ˆ
            const templatePreview = document.getElementById('template-preview');
            const previewText = existingSolution || challengeData.template;
            templatePreview.textContent = previewText.substring(0, 200) + (previewText.length > 200 ? '...' : '');
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡æ€æ¡†
            const resetModal = new bootstrap.Modal(document.getElementById('resetModal'));
            resetModal.show();
        });

        // æ¨¡æ€æ¡†ä¸­çš„ç¡®è®¤é‡ç½®æŒ‰é’®
        document.getElementById('confirmResetBtn').addEventListener('click', function() {
            const resetButton = document.getElementById('reset-editor-btn');
            const resetIcon = document.getElementById('reset-icon');
            const resetSpinner = document.getElementById('reset-spinner');
            const confirmText = document.getElementById('confirm-reset-text');
            const confirmSpinner = document.getElementById('confirm-reset-spinner');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resetIcon.classList.add('d-none');
            resetSpinner.classList.remove('d-none');
            confirmText.classList.add('d-none');
            confirmSpinner.classList.remove('d-none');
            resetButton.disabled = true;
            this.disabled = true;
            
            // æ¨¡æ‹Ÿé‡ç½®è¿‡ç¨‹ä»¥è·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
            setTimeout(() => {
                // æ¸…é™¤å·²ä¿å­˜çš„ä»£ç 
                localStorage.removeItem(`package_challenge_${challengeData.packageName}_${challengeData.challengeId}`);
                
                // é‡ç½®ä¸ºæ¨¡æ¿
                if (existingSolution) {
                    editor.setValue(existingSolution);
                } else {
                    editor.setValue(challengeData.template);
                }
                editor.clearSelection();
                
                isOriginalTemplate = true;
                hideSaveIndicators();
                
                // éšè—æ¨¡æ€æ¡†
                const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetModal'));
                resetModal.hide();
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                resetIcon.classList.remove('d-none');
                resetSpinner.classList.add('d-none');
                confirmText.classList.remove('d-none');
                confirmSpinner.classList.add('d-none');
                resetButton.disabled = false;
                this.disabled = false;
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ˆæ›´é«˜çš„ z-indexï¼‰
                setTimeout(() => {
                    showToast('æˆåŠŸ', 'ä»£ç å·²æˆåŠŸé‡ç½®ä¸ºåŸå§‹æ¨¡æ¿', 'success');
                }, 200);
            }, 800); // å°å»¶è¿Ÿä»¥è·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒåé¦ˆ
        });

        // å…¨å±åŠŸèƒ½
        document.getElementById('fullscreen-btn').addEventListener('click', function() {
            const editorWrapper = document.querySelector('.editor-wrapper');
            const icon = this.querySelector('i');
            const tooltip = bootstrap.Tooltip.getInstance(this);
            
            if (!document.fullscreenElement && !editorWrapper.classList.contains('editor-fullscreen')) {
                // è¿›å…¥å…¨å±æ¨¡å¼
                editorWrapper.classList.add('editor-fullscreen');
                icon.className = 'bi bi-fullscreen-exit';
                this.setAttribute('data-bs-original-title', 'é€€å‡ºå…¨å±æ¨¡å¼ (ESC)');
                if (tooltip) {
                    tooltip.dispose();
                    new bootstrap.Tooltip(this, { 
                        title: 'é€€å‡ºå…¨å±æ¨¡å¼ (ESC)',
                        placement: 'top'
                    });
                }
                
                // è°ƒæ•´ç¼–è¾‘å™¨ä»¥é€‚åº”å…¨å±
                setTimeout(() => {
                    editor.resize();
                    updateEditorPosition(); // è°ƒæ•´åæ›´æ–°ä½ç½®
                }, 100);
                
                // æ·»åŠ  ESC é”®ç›‘å¬å™¨
                document.addEventListener('keydown', handleEscapeKey);
            } else {
                // é€€å‡ºå…¨å±æ¨¡å¼
                exitFullscreen();
            }
        });

        function exitFullscreen() {
            const editorWrapper = document.querySelector('.editor-wrapper');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const icon = fullscreenBtn.querySelector('i');
            const tooltip = bootstrap.Tooltip.getInstance(fullscreenBtn);
            
            editorWrapper.classList.remove('editor-fullscreen');
            icon.className = 'bi bi-arrows-fullscreen';
            fullscreenBtn.setAttribute('data-bs-original-title', 'è¿›å…¥å…¨å±æ¨¡å¼ (ESC)');
            if (tooltip) {
                tooltip.dispose();
                new bootstrap.Tooltip(fullscreenBtn, { 
                    title: 'è¿›å…¥å…¨å±æ¨¡å¼ (ESC)',
                    placement: 'top'
                });
            }
            
            // å°†ç¼–è¾‘å™¨è°ƒæ•´å›æ­£å¸¸å¤§å°
            setTimeout(() => {
                editor.resize();
                updateEditorPosition(); // è°ƒæ•´åæ›´æ–°ä½ç½®
            }, 100);
            
            // ç§»é™¤ ESC é”®ç›‘å¬å™¨
            document.removeEventListener('keydown', handleEscapeKey);
        }

        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                exitFullscreen();
            }
        }

        // ä¿å­˜æŒ‡ç¤ºå™¨çš„è¾…åŠ©å‡½æ•°
        function showSavingIndicator() {
            document.getElementById('saving-indicator').classList.remove('d-none');
            document.getElementById('save-indicator').classList.add('d-none');
        }
        
        function showSaveIndicator() {
            document.getElementById('saving-indicator').classList.add('d-none');
            document.getElementById('save-indicator').classList.remove('d-none');
            
            // 2ç§’åéšè—ä¿å­˜æŒ‡ç¤ºå™¨
            setTimeout(() => {
                if (!isOriginalTemplate) {
                    document.getElementById('save-indicator').classList.add('d-none');
                }
            }, 2000);
        }
        
        function hideSaveIndicators() {
            document.getElementById('saving-indicator').classList.add('d-none');
            document.getElementById('save-indicator').classList.add('d-none');
        }

        // æ›´æ–°çŠ¶æ€æ ä¸­çš„è¡Œå’Œåˆ—å·
        function updateEditorPosition() {
            if (!editor) return;
            
            const cursor = editor.getCursorPosition();
            const lineNumber = cursor.row + 1; // Ace ä½¿ç”¨ 0 åŸºç´¢å¼•
            const colNumber = cursor.column + 1;
            
            document.getElementById('line-number').textContent = lineNumber;
            document.getElementById('col-number').textContent = colNumber;
        }
    });

    function runCode(isSubmit) {
        const runButton = document.getElementById('run-button');
        const submitButton = document.getElementById('submit-button');
        const runSpinner = document.getElementById('run-spinner');
        const submitSpinner = document.getElementById('submit-spinner');
        const runText = document.getElementById('run-text');
        const submitText = document.getElementById('submit-text');
        const testResults = document.getElementById('test-results');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (isSubmit) {
            submitSpinner.classList.remove('d-none');
            submitText.textContent = 'æäº¤ä¸­...';
            submitButton.disabled = true;
        } else {
            runSpinner.classList.remove('d-none');
            runText.textContent = 'è¿è¡Œä¸­...';
            runButton.disabled = true;
        }
        
        // åˆ‡æ¢åˆ°ç»“æœæ ‡ç­¾é¡µ
        const resultsTab = document.getElementById('results-tab');
        resultsTab.click();
        
        testResults.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm me-2"></div>è¿è¡Œæµ‹è¯•...</div>';
        
        const startTime = Date.now();
        const code = ace.edit("editor").getValue();
        const username = getUsernameFromStorage() || 'anonymous';
        
        fetch(`/api/packages/${challengeData.packageName}/${challengeData.challengeId}/${isSubmit ? 'submit' : 'test'}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                username: username
            })
        })
        .then(response => response.json())
        .then(data => {
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            displayTestResults(data, duration, isSubmit);
            showToast(
                data.success ? 'æˆåŠŸ!' : 'å¤±è´¥',
                data.success ? 
                    (isSubmit ? 'è§£å†³æ–¹æ¡ˆæäº¤æˆåŠŸ!' : 'æ‰€æœ‰æµ‹è¯•é€šè¿‡!') : 
                    'éƒ¨åˆ†æµ‹è¯•å¤±è´¥ã€‚è¯·æ£€æŸ¥ç»“æœæ ‡ç­¾é¡µã€‚',
                data.success ? 'success' : 'danger'
            );
        })
        .catch(error => {
            console.error('é”™è¯¯:', error);
            testResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>é”™è¯¯:</strong> æµ‹è¯•è¿è¡Œå¤±è´¥ã€‚è¯·é‡è¯•ã€‚
                </div>
            `;
            showToast('é”™è¯¯', 'æµ‹è¯•è¿è¡Œå¤±è´¥ã€‚è¯·é‡è¯•ã€‚', 'danger');
        })
        .finally(() => {
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            runSpinner.classList.add('d-none');
            submitSpinner.classList.add('d-none');
            runText.textContent = 'è¿è¡Œæµ‹è¯•';
            submitText.textContent = 'æäº¤è§£å†³æ–¹æ¡ˆ';
            runButton.disabled = false;
            submitButton.disabled = false;
        });
    }

    function displayTestResults(data, duration, isSubmit) {
        const testResults = document.getElementById('test-results');
        
        if (data.success) {
            html = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</strong>
                    ${data.tests_passed || 0}/${data.tests_total || 0} ä¸ªæµ‹è¯•æˆåŠŸ
                </div>
            `;
            
            // ä»…åœ¨æäº¤æ—¶æ˜¾ç¤ºèµåŠ©å•† CTAï¼Œè€Œä¸æ˜¯åœ¨æµ‹è¯•è¿è¡Œæ—¶
            if (isSubmit) {
                html += `
                    <!-- å°å‹èµåŠ©å•† CTA -->
                    <div class="alert alert-light border-0 py-2 px-3 mb-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 3px solid #28a745 !important;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-heart text-danger me-2"></i>
                                <small class="text-muted mb-0">
                                    <strong>å­¦åˆ°äº†æ–°ä¸œè¥¿ï¼Ÿ</strong><br>
                                    è¡¨è¾¾ä¸€äº›å–œçˆ±ï¼Œå¸®åŠ©æˆ‘ä»¬ç»§ç»­æ„å»º â¤ï¸
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="https://github.com/RezaSi/go-interview-practice" 
                                   class="btn btn-sm btn-outline-secondary d-flex align-items-center" 
                                   target="_blank" 
                                   style="font-size: 0.8rem; border-radius: 12px;">
                                    <i class="bi bi-star me-1" style="font-size: 0.7rem;"></i>
                                    Star
                                </a>
                                <a href="https://github.com/sponsors/RezaSi" 
                                   class="btn btn-sm btn-outline-primary d-flex align-items-center" 
                                   target="_blank" 
                                   style="font-size: 0.8rem; border-radius: 12px;">
                                    <i class="bi bi-heart-fill me-1" style="font-size: 0.7rem;"></i>
                                    èµåŠ©
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // å¯¹äºæˆåŠŸçš„æäº¤æ˜¾ç¤º PR æŒ‡ä»¤
            if (isSubmit && data.show_pr_instructions) {
                const username = getUsernameFromStorage() || 'anonymous';
                
                // æ›¿æ¢æˆåŠŸè­¦æŠ¥ä¸ºç»Ÿä¸€æ ¼å¼
                html = html.replace(
                    /<div class="alert alert-success">[\s\S]*?<\/div>/,
                    `<div class="alert alert-success mb-3">
                        <h4 class="alert-heading">è§£å†³æ–¹æ¡ˆæäº¤æˆåŠŸï¼ ğŸ‰</h4>
                        <p>æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚æ‰§è¡Œæ—¶é—´: ${duration}ms</p>
                        <hr>
                        <p class="mb-0">æŒ‰ç…§ä»¥ä¸‹è¯´æ˜å°†æ‚¨çš„è§£å†³æ–¹æ¡ˆæäº¤åˆ°å…¬å…±æ’è¡Œæ¦œã€‚</p>
                    </div>`
                );
                
                html += `
                    <div class="alert alert-info mb-3">
                        <h5>ğŸš€ ä¸‹ä¸€æ­¥ï¼šåˆ›å»ºæ‹‰å–è¯·æ±‚</h5>
                        <p class="mb-3">ä¸ºäº†å°†æ‚¨çš„è§£å†³æ–¹æ¡ˆè´¡çŒ®ç»™é¡¹ç›®å¹¶åœ¨å…¬å…±æ’è¡Œæ¦œä¸Šæ˜¾ç¤ºï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
                        
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-primary" id="save-filesystem-btn">ğŸ’¾ ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ</button>
                            <button class="btn btn-secondary" id="copy-commands-btn">ğŸ“‹ å¤åˆ¶ Git å‘½ä»¤</button>
                        </div>
                        
                        <div class="accordion" id="submissionAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1" aria-expanded="true">
                                        <strong>æ­¥éª¤ 1ï¼šå°†è§£å†³æ–¹æ¡ˆæœ¬åœ°ä¿å­˜</strong>
                                    </button>
                                </h2>
                                <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#submissionAccordion">
                                    <div class="accordion-body">
                                        <p>ç‚¹å‡»ä¸Šæ–¹çš„â€œğŸ’¾ ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿâ€æŒ‰é’®ï¼Œç›´æ¥å°†æ‚¨çš„è§£å†³æ–¹æ¡ˆä¿å­˜åˆ°æ­£ç¡®ä½ç½®ã€‚</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                                        <strong>æ­¥éª¤ 2ï¼šæäº¤å¹¶æ¨é€è‡³æ‚¨çš„åˆ†æ”¯</strong>
                                    </button>
                                </h2>
                                <div id="step2" class="accordion-collapse collapse" data-bs-parent="#submissionAccordion">
                                    <div class="accordion-body">
                                        <p>è¿è¡Œä»¥ä¸‹ Git å‘½ä»¤å°†æ‚¨çš„æ›´æ”¹ä¿å­˜åˆ°æ‚¨çš„åˆ†å‰ä»“åº“ä¸­ï¼š</p>
                                        <div class="bg-dark text-light p-3 rounded">
                                            <pre><code>$ cd ../../../
$ git add packages/${challengeData.packageName}/${challengeData.challengeId}/submissions/${username}/
$ git commit -m "Add solution for ${challengeData.packageName} ${challengeData.challengeId} by ${username}"
$ git push origin main</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                                        <strong>æ­¥éª¤ 3ï¼šåœ¨ GitHub ä¸Šåˆ›å»ºæ‹‰å–è¯·æ±‚</strong>
                                    </button>
                                </h2>
                                <div id="step3" class="accordion-collapse collapse" data-bs-parent="#submissionAccordion">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>è½¬åˆ°æ‚¨çš„åˆ†å‰ä»“åº“ï¼š <code>https://github.com/${username}/go-interview-practice</code></li>
                                            <li>æ‚¨åº”è¯¥çœ‹åˆ°ä¸€ä¸ª bannerï¼Œæ˜¾ç¤ºâ€œæ­¤åˆ†æ”¯æ¯” RezaSi:main å‰è¿› X æäº¤â€</li>
                                            <li>ç‚¹å‡»å…¶æ—è¾¹çš„ <strong>"Contribute"</strong> æŒ‰é’®</li>
                                            <li>ç‚¹å‡» <strong>"Open pull request"</strong></li>
                                            <li>æ·»åŠ æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼š<code>Add solution for ${challengeData.packageName} ${challengeData.challengeId} by ${username}</code></li>
                                            <li>ç‚¹å‡» <strong>"Create pull request"</strong></li>
                                        </ol>
                                        <div class="alert alert-success mt-3">
                                            <strong>ğŸ‰ å®Œæˆï¼</strong> æ‚¨çš„è§£å†³æ–¹æ¡ˆå°†è¢«å®¡æŸ¥å¹¶åˆå¹¶ï¼Œå‡ºç°åœ¨å…¬å…±æ’è¡Œæ¦œä¸Šã€‚
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // åœ¨ HTML æ’å…¥åæ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                setTimeout(() => {
                    const saveFilesystemBtn = document.getElementById('save-filesystem-btn');
                    const copyCommandsBtn = document.getElementById('copy-commands-btn');
                    
                    if (saveFilesystemBtn) {
                        saveFilesystemBtn.addEventListener('click', function() {
                            this.disabled = true;
                            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¿å­˜ä¸­...';
                            
                            fetch('/api/packages-save-to-filesystem', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    username: username,
                                    packageName: challengeData.packageName,
                                    challengeId: challengeData.challengeId,
                                    code: ace.edit("editor").getValue()
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showToast('æˆåŠŸ', 'è§£å†³æ–¹æ¡ˆå·²ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿï¼', 'success');
                                    
                                    // æ˜¾ç¤ºåŒ…å« PR åˆ›å»ºçš„ç»¼åˆä¸‹ä¸€æ­¥
                                    let nextStepsHtml = `
                                        <div class="mt-3 p-3 bg-light rounded">
                                            <h6>âœ… è§£å†³æ–¹æ¡ˆå·²ä¿å­˜ï¼ä¸‹ä¸€æ­¥ï¼š</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary">1. æäº¤å¹¶æ¨é€åˆ°æ‚¨çš„åˆ†å‰ï¼š</h6>
                                                    <div class="bg-dark text-light p-2 rounded small">
                                                        <pre><code>cd ../../../
git add packages/${challengeData.packageName}/${challengeData.challengeId}/submissions/${username}/
git commit -m "Add solution for ${challengeData.packageName} ${challengeData.challengeId} by ${username}"
git push origin main</code></pre>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-success">2. åˆ›å»ºæ‹‰å–è¯·æ±‚ï¼š</h6>
                                                    <ol class="small">
                                                        <li>è½¬åˆ° <a href="https://github.com/${username}/go-interview-practice" target="_blank">æ‚¨çš„åˆ†å‰</a></li>
                                                        <li>ç‚¹å‡» "Contribute" æŒ‰é’®</li>
                                                        <li>ç‚¹å‡» "Open pull request"</li>
                                                        <li>æ·»åŠ æ ‡é¢˜ï¼š"Add solution for ${challengeData.packageName} ${challengeData.challengeId}"</li>
                                                        <li>æäº¤æ‚¨çš„ PRï¼ ğŸ‰</li>
                                                    </ol>
                                                </div>
                                            </div>
                                            <div class="alert alert-info mt-2 small">
                                                <strong>ğŸ”— ç›´æ¥é“¾æ¥ï¼š</strong> æ¨é€åï¼ŒGitHub é€šå¸¸ä¼šæ˜¾ç¤ºä¸€ä¸ªå¸¦æœ‰ç›´æ¥ "Compare & pull request" æŒ‰é’®çš„æ¨ªå¹…ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚
                                            </div>
                                        </div>
                                    `;
                                    
                                    // åœ¨æŒ‰é’®ä¹‹åæ’å…¥
                                    this.parentNode.insertAdjacentHTML('afterend', nextStepsHtml);
                                } else {
                                    showToast('é”™è¯¯', data.message || 'æ— æ³•ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ', 'error');
                                }
                                
                                this.disabled = false;
                                this.textContent = 'å·²ä¿å­˜ï¼';
                                setTimeout(() => {
                                    this.textContent = 'ğŸ’¾ ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ';
                                }, 2000);
                            })
                            .catch(error => {
                                showToast('é”™è¯¯', 'ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                                this.disabled = false;
                                this.textContent = 'ğŸ’¾ ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ';
                            });
                        });
                    }
                    
                    if (copyCommandsBtn) {
                        copyCommandsBtn.addEventListener('click', function() {
                            const commands = `cd ../../../
git add packages/${challengeData.packageName}/${challengeData.challengeId}/submissions/${username}/
git commit -m "Add solution for ${challengeData.packageName} ${challengeData.challengeId} by ${username}"
git push origin main`;
                            
                            navigator.clipboard.writeText(commands).then(() => {
                                showToast('æˆåŠŸ', 'Git å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                                this.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                                setTimeout(() => {
                                    this.textContent = 'ğŸ“‹ å¤åˆ¶ Git å‘½ä»¤';
                                }, 2000);
                            }).catch(() => {
                                showToast('é”™è¯¯', 'æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿', 'error');
                            });
                        });
                    }
                }, 100);
            }
        } else {
            html += `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    <strong>æµ‹è¯•å¤±è´¥ï¼š</strong>
                    ${data.tests_passed || 0}/${data.tests_total || 0} ä¸ªæµ‹è¯•é€šè¿‡
                </div>
            `;
        }
        
        if (data.output) {
            html += `
                <div class="mt-3">
                    <h6>è¾“å‡ºï¼š</h6>
                    <pre class="bg-light p-3 rounded"><code>${escapeHtml(data.output)}</code></pre>
                </div>
            `;
        }
        
        if (data.error) {
            html += `
                <div class="mt-3">
                    <h6>é”™è¯¯ï¼š</h6>
                    <pre class="bg-light p-3 rounded text-danger"><code>${escapeHtml(data.error)}</code></pre>
                </div>
            `;
        }
        
        testResults.innerHTML = html;
    }

    function showToast(title, message, type) {
        const toastContainer = document.querySelector('.position-fixed.bottom-0.end-0');
        const toast = document.getElementById('statusToast');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        
        // ä¿®å¤ z-index é—®é¢˜
        toastContainer.style.zIndex = '10000';
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // æ ¹æ®ç±»å‹æ›´æ–°æç¤ºæ ·å¼
        toast.className = 'toast';
        if (type === 'success') {
            toast.classList.add('bg-success', 'text-white');
        } else if (type === 'danger' || type === 'error') {
            toast.classList.add('bg-danger', 'text-white');
        } else if (type === 'warning') {
            toast.classList.add('bg-warning', 'text-dark');
        } else {
            toast.classList.add('bg-info', 'text-white');
        }
        
        const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
        bsToast.show();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getUsernameFromStorage() {
        return localStorage.getItem('githubUsername') || localStorage.getItem('username') || sessionStorage.getItem('username');
    }

    // æç¤ºç³»ç»ŸåŠŸèƒ½
    function initializeHints(hintsMarkdown) {
        const hintsContainer = document.getElementById('hints-container');
        const showHintBtn = document.getElementById('show-hint-btn');
        const resetHintsBtn = document.getElementById('reset-hints-btn');
        const hintsProgress = document.getElementById('hints-progress');
        const totalHints = document.getElementById('total-hints');
        
        if (!hintsContainer || !showHintBtn || !resetHintsBtn) return;
        
        // ä» Markdown è§£ææç¤º
        const hints = parseHintsFromMarkdown(hintsMarkdown);
        let currentHintIndex = 0;
        
        // æ›´æ–°æ€»æç¤ºæ•°
        totalHints.textContent = hints.length;
        
        // æ˜¾ç¤ºæç¤ºæŒ‰é’®åŠŸèƒ½
        showHintBtn.addEventListener('click', function() {
            if (currentHintIndex < hints.length) {
                showHint(hints[currentHintIndex], currentHintIndex + 1);
                currentHintIndex++;
                updateHintsProgress();
                
                // å½“è‡³å°‘æ˜¾ç¤ºä¸€ä¸ªæç¤ºæ—¶æ˜¾ç¤ºé‡ç½®æŒ‰é’®
                if (currentHintIndex > 0) {
                    resetHintsBtn.classList.remove('d-none');
                }
                
                // å½“æ‰€æœ‰æç¤ºéƒ½æ­ç¤ºåéšè—æ˜¾ç¤ºæŒ‰é’®
                if (currentHintIndex >= hints.length) {
                    showHintBtn.classList.add('d-none');
                }
            }
        });
        
        // é‡ç½®æç¤ºæŒ‰é’®åŠŸèƒ½
        resetHintsBtn.addEventListener('click', function() {
            currentHintIndex = 0;
            hintsContainer.innerHTML = '';
            showHintBtn.classList.remove('d-none');
            resetHintsBtn.classList.add('d-none');
            updateHintsProgress();
        });
        
        function showHint(hint, hintNumber) {
            const hintElement = document.createElement('div');
            hintElement.className = 'alert alert-info hint-item mb-3';
            hintElement.style.animation = 'slideIn 0.3s ease-in-out';
            hintElement.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0">
                        <span class="badge bg-warning text-dark me-2">æç¤º ${hintNumber}</span>
                    </div>
                    <div class="flex-grow-1 markdown-content">
                        ${hint.content}
                    </div>
                </div>
            `;
            hintsContainer.appendChild(hintElement);
            
            // æ»šåŠ¨æç¤ºåˆ°è§†å›¾ä¸­
            hintElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updateHintsProgress() {
            hintsProgress.textContent = currentHintIndex;
        }
        
        function parseHintsFromMarkdown(markdown) {
            if (!markdown || markdown.trim() === '' || markdown.includes('*No hints available')) {
                return [];
            }
            
            const hints = [];
            const lines = markdown.split('\n');
            let currentHint = null;
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                // æ£€æŸ¥è¿™æ˜¯å¦æ˜¯æç¤ºæ ‡é¢˜ (## Hint N:)
                const hintMatch = trimmedLine.match(/^##\s+Hint\s+\d+:\s*(.*)$/i);
                if (hintMatch) {
                    // ä¿å­˜ä¹‹å‰çš„æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (currentHint) {
                        hints.push(currentHint);
                    }
                    
                    // å¼€å§‹æ–°çš„æç¤º
                    currentHint = {
                        title: hintMatch[1],
                        content: ''
                    };
                } else if (currentHint && trimmedLine && !trimmedLine.startsWith('#')) {
                    // å°†å†…å®¹æ·»åŠ åˆ°å½“å‰æç¤º
                    if (currentHint.content) {
                        currentHint.content += '\n';
                    }
                    currentHint.content += line;
                }
            }
            
            // æ·»åŠ æœ€åä¸€ä¸ªæç¤º
            if (currentHint) {
                hints.push(currentHint);
            }
            
            // ä½¿ç”¨é€‚å½“çš„ Markdown è§£æå™¨å°† Markdown å†…å®¹è½¬æ¢ä¸º HTML
            hints.forEach(hint => {
                const tempDiv = document.createElement('div');
                renderMarkdown(hint.content.trim(), tempDiv);
                hint.content = tempDiv.innerHTML;
            });
            
            return hints;
        }
    }
</script>
{{end}}