{{define "content"}}
<div class="row mb-4" id="setup">
  <div class="col">
    <div class="card shadow-lg border-0">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0"><i class="bi bi-person-workspace me-2"></i>面试模拟器</h3>
      </div>
      <div class="card-body bg-light">
        <p class="text-muted mb-4">🚀 选择挑战题，设置时长，开始你的编码面试。实时获得反馈并追踪你的进步！</p>

        <div class="mb-3 d-flex align-items-center gap-2">
          <span class="badge rounded-pill bg-primary">1</span>
          <span class="fw-semibold">选择挑战题</span>
          <span class="ms-auto small text-muted">已选： <span id="selected-count">0</span></span>
        </div>

        <div id="step-1" class="card border-primary mb-4">
          <div class="card-header bg-white">
            <div class="row g-2 align-items-center">
              <div class="col-md-6">
                <input id="challenge-search" class="form-control form-control-sm" placeholder="🔍 按标题或编号搜索挑战题..." />
              </div>
              <div class="col-md-6 text-md-end">
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-secondary active" data-filter="all">全部</button>
                  <button type="button" class="btn btn-outline-success" data-filter="beginner">初级</button>
                  <button type="button" class="btn btn-outline-warning" data-filter="intermediate">中级</button>
                  <button type="button" class="btn btn-outline-danger" data-filter="advanced">高级</button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush" id="challenge-checkboxes" style="max-height: 320px; overflow:auto;"></div>
          </div>
          <div class="card-footer bg-white d-flex justify-content-end">
            <button type="button" id="to-step-2" class="btn btn-primary" disabled>
              下一步 <i class="bi bi-arrow-right-short ms-1"></i>
            </button>
          </div>
        </div>

        <div class="mb-3 d-flex align-items-center gap-2">
          <span class="badge rounded-pill bg-primary">2</span>
          <span class="fw-semibold">时长与开始</span>
        </div>

        <div id="step-2" class="card border-success">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label fw-semibold">⏱️ 时长（分钟）</label>
                <input id="interview-duration" type="number" class="form-control form-control-lg" min="5" max="240" value="45" />
                <div class="form-text">建议：30-60 分钟</div>
              </div>
              <div class="col-md-8 text-md-end">
                <button type="button" id="back-to-step-1" class="btn btn-outline-secondary me-2"><i class="bi bi-arrow-left-short me-1"></i>返回</button>
                <button type="button" id="start-interview" class="btn btn-success btn-lg">
                  <i class="bi bi-play-circle me-1"></i>开始面试
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  </div>

  <div id="interview-session" class="row" style="display:none;">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>正在进行的面试</h5>
              <small class="opacity-75" id="session-meta"></small>
            </div>
            <div class="d-flex align-items-center gap-3">
              <span class="badge bg-dark fs-5 px-3 py-2 font-monospace" id="timer">--:--</span>
              <div class="dropdown">
                <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-flag-fill me-1"></i>结束面试
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><button class="dropdown-item" id="finish-interview">
                    <i class="bi bi-flag-fill me-2 text-warning"></i>结束并提交
                  </button></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><button class="dropdown-item" id="save-progress">
                    <i class="bi bi-save me-2 text-info"></i>保存进度
                  </button></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <!-- 问题描述与AI助手标签页 -->
              <div class="card h-100 border-primary border-2">
                <div class="card-header bg-primary text-white p-0">
                  <ul class="nav nav-tabs nav-fill border-0" id="sidebar-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active border-0 fw-semibold" id="problem-tab" data-bs-toggle="tab" data-bs-target="#problem-content" type="button" role="tab" style="background: rgba(255,255,255,0.2); color: white;">
                        <i class="bi bi-file-text me-1"></i>题目
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link border-0 fw-semibold" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-content" type="button" role="tab" style="color: rgba(255,255,255,0.7);">
                        <i class="bi bi-robot me-1"></i>AI助手
                      </button>
                    </li>
                  </ul>
                </div>
                <div class="card-body p-0">
                  <div class="tab-content h-100" id="sidebar-tab-content">
                    <!-- 问题描述标签页 -->
                    <div class="tab-pane fade show active h-100" id="problem-content" role="tabpanel">
                      <div class="p-3 h-100 d-flex flex-column">
                        <div class="mb-3 p-2 bg-light rounded">
                          <div class="small text-muted mb-1">当前挑战：</div>
                          <div><span class="badge bg-secondary">#<span id="preview-challenge-id">-</span></span> <span id="preview-challenge-title" class="fw-semibold"></span></div>
                        </div>
                        <div class="flex-grow-1" style="overflow-y: auto; max-height: 550px;">
                          <div id="preview-description" class="markdown-content" style="font-size: 0.9rem;"></div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- AI助手标签页 -->
                    <div class="tab-pane fade h-100" id="ai-content" role="tabpanel">
                      <div class="p-3 h-100 d-flex flex-column">
                        <div class="text-center mb-3">
                          <div class="d-inline-block p-3 bg-primary bg-opacity-10 rounded-circle mb-3">
                            <i class="bi bi-robot fs-2 text-primary"></i>
                          </div>
                          <h6 class="text-primary mb-1">AI助手</h6>
                          <p class="small text-muted mb-0">你的编程伙伴</p>
                        </div>
                        
                        <!-- AI操作按钮 -->
                        <div class="d-grid gap-2">
                          <button type="button" class="btn btn-primary btn-sm" onclick="requestAIReview()">
                            <i class="bi bi-search me-1"></i> 获取AI代码审查
                          </button>
                          <button type="button" class="btn btn-info btn-sm" onclick="requestInterviewQuestions()">
                            <i class="bi bi-chat-dots me-1"></i> 向面试官提问
                          </button>
                          <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-warning btn-sm" onclick="requestHint(1)">
                              💡 提示 Lv1
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="requestHint(2)">
                              Lv2
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="requestHint(3)">
                              Lv3
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="requestHint(4)">
                              Lv4
                            </button>
                          </div>
                        </div>
                        
                        <!-- AI响应区域 -->
                        <div id="ai-response-area" class="mt-3" style="display: none;">
                          <div class="card border-0 bg-light">
                            <div class="card-header bg-primary text-white py-2">
                              <h6 class="mb-0">
                                <i class="bi bi-robot me-1"></i>
                                <span id="ai-response-title">AI反馈</span>
                              </h6>
                            </div>
                            <div class="card-body p-3" id="ai-response-content">
                              <!-- AI响应将显示在这里 -->
                            </div>
                          </div>
                        </div>
                        
                        <div class="mt-auto">
                          <div class="alert alert-success py-2 px-3 mb-0 small">
                            <i class="bi bi-check-circle me-1"></i>
                            <strong>AI就绪！</strong> 点击上方按钮获取AI帮助。
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div id="challenge-container" style="display:none;">
                <div class="card border-0 bg-light mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 id="challenge-title" class="mb-1 text-primary"></h5>
                        <small class="text-muted">挑战 #<span id="challenge-id"></span> • <span id="challenge-difficulty" class="text-capitalize"></span></small>
                      </div>
                      <div class="d-flex flex-wrap gap-2 align-items-center">
                        <div class="btn-group btn-group-sm me-2" role="group" aria-label="导航问题">
                          <button type="button" id="prev-question" class="btn btn-outline-primary"><i class="bi bi-chevron-left"></i></button>
                          <div id="question-pager" class="btn-group btn-group-sm"></div>
                          <button type="button" id="next-question" class="btn btn-outline-primary"><i class="bi bi-chevron-right"></i></button>
                        </div>
                        <button type="button" id="run-tests" class="btn btn-success btn-sm">
                          <span class="btn-label"><i class="bi bi-play"></i> 运行测试</span>
                          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="editor-container" id="editor"></div>
                <div class="mt-3">
                  <div class="card border-0">
                    <div class="card-header bg-info text-white py-2">
                      <h6 class="mb-0"><i class="bi bi-terminal me-1"></i>测试输出</h6>
                    </div>
                    <div class="card-body">
                      <div class="test-results p-2 bg-dark text-light rounded" id="test-output" style="min-height:80px; font-family: 'Courier New', monospace; font-size: 0.85rem;"></div>
                      <div class="small text-muted mt-2" id="exec-time" style="display:none;"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="challenge-placeholder" class="text-center py-5" style="display:block;">
                <div class="text-muted">
                  <i class="bi bi-hourglass-split fs-1 d-block mb-3"></i>
                  <h5 class="text-muted">正在加载你的第一个挑战...</h5>
                  <p class="small">请稍等，我们正在准备你的面试会话。</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>面试历史</h5>
          <button id="clear-history" class="btn btn-sm btn-outline-light"><i class="bi bi-trash"></i> 清空所有</button>
        </div>
        <div class="card-body" id="history-list">
          <div class="text-muted text-center py-3">
            <i class="bi bi-journal-x fs-2 d-block mb-2"></i>
            尚无面试记录。开始你的第一次面试以查看进度！
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- 结束面试模态框 -->
  <div class="modal fade" id="finishInterviewModal" tabindex="-1" aria-labelledby="finishInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="finishInterviewModalLabel">
            <i class="bi bi-flag-fill me-2"></i>结束面试
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-4">
            <i class="bi bi-question-circle fs-1 text-warning"></i>
          </div>
          <h4 class="mb-3">确定要结束吗？</h4>
          <p class="text-muted mb-4">你的面试会话将结束，并根据已完成的挑战获得最终评分。</p>
          <div class="row g-3 mb-4">
            <div class="col-6">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <div class="fw-bold text-primary" id="modal-time-remaining">--:--</div>
                  <small class="text-muted">剩余时间</small>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <div class="fw-bold text-success" id="modal-challenges-completed">0/0</div>
                  <small class="text-muted">尝试的挑战</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-arrow-left me-1"></i>继续面试
          </button>
          <button type="button" class="btn btn-warning" id="confirm-finish-interview">
            <i class="bi bi-flag-fill me-1"></i>是的，结束面试
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 清空历史模态框 -->
  <div class="modal fade" id="clearHistoryModal" tabindex="-1" aria-labelledby="clearHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="clearHistoryModalLabel">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>清空面试历史
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-4">
            <i class="bi bi-trash3 fs-1 text-danger"></i>
          </div>
          <h4 class="mb-3">确定要清空吗？</h4>
          <p class="text-muted mb-4">这将永久删除你所有的面试历史和分数。此操作无法撤销。</p>
          <div class="alert alert-warning">
            <i class="bi bi-info-circle me-2"></i>
            <strong>警告：</strong> 你过去的所有面试记录将永远丢失。
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>取消
          </button>
          <button type="button" class="btn btn-danger" id="confirm-clear-history">
            <i class="bi bi-trash3 me-1"></i>是的，清空所有历史
          </button>
        </div>
      </div>
    </div>
  </div>
{{end}}

{{define "scripts"}}
<script>
(function(){
  const lsKeyHistory = 'interview_history_v1';
  const sessionKeyPrefix = 'interview_session_v1_';
  let editor = null;
  let currentSession = null;
  let timerInterval = null;
  let activeFilter = 'all';
  const allChallenges = [
    {{- $first := true -}}
    {{- range .Challenges -}}
    {{- if not $first }},{{ end -}}
    { id: {{.ID}}, title: "{{js .Title}}", difficulty: "{{lower .Difficulty}}" }
    {{- $first = false -}}
    {{- end -}}
  ];
  const selectedIds = new Set();

  function getUsername() {
    const input = document.getElementById('username');
    const profile = document.getElementById('profile-username');
    return (profile && profile.textContent) || (input && input.value) || '';
  }

  function loadHistory() {
    try {
      const data = JSON.parse(localStorage.getItem(lsKeyHistory) || '[]');
      return Array.isArray(data) ? data : [];
    } catch { return []; }
  }

  function saveHistory(history) {
    localStorage.setItem(lsKeyHistory, JSON.stringify(history));
  }

  function renderHistory() {
    const container = document.getElementById('history-list');
    const history = loadHistory();
    if (!history.length) { 
      container.innerHTML = `
        <div class="text-muted text-center py-3">
          <i class="bi bi-journal-x fs-2 d-block mb-2"></i>
          尚无面试记录。开始你的第一次面试以查看进度！
        </div>`;
      return; 
    }
    container.innerHTML = '';
    history.slice().reverse().forEach(item => {
      const div = document.createElement('div');
      div.className = 'card border-0 shadow-sm mb-3';
      const dt = new Date(item.startedAt);
      const tests = `${item.totalTestsPassed || 0}/${item.totalTests || 0}`;
      const challenges = `${item.solvedChallenges || 0}/${item.totalChallenges || item.challengeIds.length}`;
      const scoreColor = item.score >= 80 ? 'success' : item.score >= 60 ? 'warning' : 'danger';
      div.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="mb-1">${item.title || '自定义面试'}</h6>
              <div class="small text-muted">
                <i class="bi bi-calendar me-1"></i>${dt.toLocaleString()} • 
                <i class="bi bi-clock me-1"></i>${item.duration}m • 
                <i class="bi bi-list-check me-1"></i>${item.challengeIds.length} 个挑战
              </div>
            </div>
            <div class="text-end">
              <div class="badge bg-${scoreColor} fs-6 mb-1">得分：${item.score}%</div>
              <div class="small text-muted">完成：${challenges}</div>
              <div class="small text-muted">测试：${tests}</div>
            </div>
          </div>
        </div>`;
      container.appendChild(div);
    });
  }

  function startTimer(minutes) {
    const endAt = Date.now() + minutes*60*1000;
    const el = document.getElementById('timer');
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const remain = Math.max(0, endAt - Date.now());
      const m = Math.floor(remain/60000);
      const s = Math.floor((remain%60000)/1000);
      el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      if (remain === 0) {
        clearInterval(timerInterval);
        finishInterview();
      }
    }, 250);
  }

  function createEditorIfNeeded() {
    if (!editor) {
      editor = createEditor('editor', '');
    }
  }

  async function fetchChallenge(id) {
    const res = await fetch(`/api/challenges/${id}`);
    if (!res.ok) throw new Error('获取挑战失败');
    return res.json();
  }

  function persistSession() {
    if (!currentSession) return;
    localStorage.setItem(sessionKeyPrefix + currentSession.id, JSON.stringify(currentSession));
  }

  function initSession(challengeIds, duration) {
    currentSession = {
      id: Date.now().toString(36),
      title: `面试 ${new Date().toLocaleString()}`,
      username: getUsername(),
      challengeIds: challengeIds.map(Number),
      duration,
      startedAt: Date.now(),
      answers: {},        // challengeId -> code
      results: {},        // challengeId -> {passed, testsPassed, testsTotal}
    };
    persistSession();
  }

  function updateSessionMeta() {
    const meta = document.getElementById('session-meta');
    meta.textContent = `${currentSession.challengeIds.length} 个挑战 • ${currentSession.duration} 分钟`;
  }

  function renderChallengeList() {
    // 渲染数字分页按钮
    const pager = document.getElementById('question-pager');
    if (!pager) return;
    pager.innerHTML = '';
    const ordered = [...currentSession.challengeIds].map(Number).sort((a,b)=>a-b);
    const currentId = Number(document.getElementById('challenge-id').textContent || ordered[0]);
    ordered.forEach((id, idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn ' + (id===currentId ? 'btn-primary' : 'btn-outline-secondary');
      btn.textContent = String(idx+1);
      btn.title = `#${id}`;
      btn.addEventListener('click', () => openChallenge(id));
      pager.appendChild(btn);
    });
  }

  async function openChallenge(id) {
    createEditorIfNeeded();
    const container = document.getElementById('challenge-container');
    const placeholder = document.getElementById('challenge-placeholder');
    container.style.display = 'block';
    placeholder.style.display = 'none';

    const ch = await fetchChallenge(id);
    document.getElementById('challenge-title').textContent = ch.title;
    document.getElementById('challenge-id').textContent = ch.id;
    document.getElementById('challenge-difficulty').textContent = ch.difficulty;
    // 更新右侧预览
    const prevTitle = document.getElementById('preview-challenge-title');
    const prevId = document.getElementById('preview-challenge-id');
    const prevDesc = document.getElementById('preview-description');
    if (prevTitle && prevId && prevDesc) {
      prevTitle.textContent = ch.title;
      prevId.textContent = ch.id;
      prevDesc.innerHTML = '';
      if (typeof renderMarkdownAndCleanup === 'function') {
        renderMarkdownAndCleanup(ch.description || '', prevDesc);
      } else if (typeof renderMarkdown === 'function') {
        renderMarkdown(ch.description || '', prevDesc);
      } else {
        prevDesc.textContent = ch.description || '';
      }
    }
    const saved = currentSession.answers[id] ?? ch.template;
    editor.setValue(saved || '', -1);
    
    // 更新分页按钮以显示当前选择
    renderChallengeList();
    
    // 切换到问题标签页以显示新挑战描述
    const problemTab = document.getElementById('problem-tab');
    if (problemTab) {
      const tab = new bootstrap.Tab(problemTab);
      tab.show();
    }
  }

  async function runTestsForCurrent() {
    const id = Number(document.getElementById('challenge-id').textContent);
    if (!id) return;
    const code = editor.getValue();
    const btn = document.getElementById('run-tests');
    const label = btn.querySelector('.btn-label');
    const spinner = btn.querySelector('.spinner-border');
    const outputEl = document.getElementById('test-output');
    const execTimeEl = document.getElementById('exec-time');

    // 加载中UI
    btn.disabled = true;
    spinner.classList.remove('d-none');
    label.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
    outputEl.innerHTML = '<div class="d-flex align-items-center text-muted"><div class="spinner-border spinner-border-sm me-2" role="status"></div> 运行测试...</div>';
    execTimeEl.style.display = 'none';

    let data;
    try {
      const res = await fetch('/api/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ challengeId: id, code }) });
      data = await res.json();
    } catch (e) {
      outputEl.innerHTML = '<span class="text-danger">运行测试失败。请重试。</span>';
      btn.disabled = false;
      spinner.classList.add('d-none');
      label.innerHTML = '<i class="bi bi-play"></i> 测试';
      return;
    }
    // 解析测试结果，如后端对包的处理方式
    const output = data.output || '';
    const lines = output.split('\n');
    let passed = 0, total = 0;
    lines.forEach(l => {
      if (l.includes('--- PASS:')) { passed++; total++; }
      else if (l.includes('--- FAIL:')) { total++; }
    });
    if (total === 0) {
      if (output.includes('PASS') && !output.includes('FAIL')) { passed = 1; total = 1; }
      else if (output.includes('FAIL')) { passed = 0; total = 1; }
    }

    currentSession.answers[id] = code;
    currentSession.results[id] = { passed: data.passed, testsPassed: passed, testsTotal: total, executionMs: data.executionMs };
    persistSession();

    outputEl.innerHTML = formatTestOutput(output);
    if (data.executionMs !== undefined) {
      execTimeEl.textContent = `执行时间：${formatExecutionTime(data.executionMs)}`;
      execTimeEl.style.display = 'block';
    }
    renderChallengeList();

    // 重置UI
    btn.disabled = false;
    spinner.classList.add('d-none');
    label.innerHTML = '<i class="bi bi-play"></i> 测试';
  }

  function saveProgress() {
    const id = Number(document.getElementById('challenge-id').textContent);
    if (!id) return;
    currentSession.answers[id] = editor.getValue();
    persistSession();
  }

  function computeScore() {
    let totalChallenges = currentSession.challengeIds.length;
    let solvedChallenges = 0;
    let totalTestsPassed = 0;
    let totalTestsRun = 0;
    
    // 计算解决的挑战数（所有测试通过）与总挑战数
    for (const id of currentSession.challengeIds) {
      const r = currentSession.results[id];
      if (r) {
        totalTestsRun += (r.testsTotal || 0);
        totalTestsPassed += (r.testsPassed || 0);
        
        // 只有当所有测试都通过时，才认为挑战已解决
        if (r.testsPassed > 0 && r.testsPassed === r.testsTotal) {
          solvedChallenges++;
        }
      }
      // 如果未尝试，则计为0（未解决）
    }
    
    // 得分基于解决的挑战数，而非单个测试
    const score = totalChallenges ? Math.round((solvedChallenges / totalChallenges) * 100) : 0;
    
    return { 
      score, 
      totalPassed: totalTestsPassed, 
      totalTests: totalTestsRun,
      solvedChallenges,
      totalChallenges
    };
  }

  function finishInterview() {
    if (!currentSession) return;
    const { score, totalPassed, totalTests, solvedChallenges, totalChallenges } = computeScore();

    // 保存到历史记录
    const history = loadHistory();
    history.push({
      title: currentSession.title,
      username: currentSession.username,
      startedAt: currentSession.startedAt,
      duration: currentSession.duration,
      challengeIds: currentSession.challengeIds,
      score,
      totalTestsPassed: totalPassed,
      totalTests,
      solvedChallenges,
      totalChallenges
    });
    saveHistory(history);
    renderHistory();

    // 重置UI
    clearInterval(timerInterval);
    document.getElementById('interview-session').style.display = 'none';
    document.getElementById('setup').style.display = 'block';
    
    // 在一个漂亮的模态框中显示结果
    showFinishResultsModal(score, totalPassed, totalTests, solvedChallenges, totalChallenges);
    currentSession = null;
  }

  function showFinishResultsModal(score, testsPassed, testsTotal, solvedChallenges, totalChallenges) {
    const scoreColor = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
    const modalContent = `
      <div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-${scoreColor} text-white">
              <h5 class="modal-title">
                <i class="bi bi-trophy-fill me-2"></i>面试已完成！
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <div class="mb-4">
                <div class="display-1 fw-bold text-${scoreColor}">${score}%</div>
                <p class="text-muted">你的最终得分</p>
              </div>
              <div class="row g-3 mb-4">
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <div class="fw-bold text-success">${solvedChallenges}</div>
                      <small class="text-muted">已解决挑战</small>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <div class="fw-bold text-primary">${totalChallenges}</div>
                      <small class="text-muted">总挑战数</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row g-3 mb-4">
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <div class="fw-bold text-info">${testsPassed}</div>
                      <small class="text-muted">通过测试</small>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <div class="fw-bold text-secondary">${testsTotal}</div>
                      <small class="text-muted">运行测试</small>
                    </div>
                  </div>
                </div>
              </div>
              ${score >= 80 ? 
                '<div class="alert alert-success"><i class="bi bi-star-fill me-2"></i>表现优秀！你已准备好技术面试。</div>' :
                score >= 60 ?
                '<div class="alert alert-warning"><i class="bi bi-lightbulb me-2"></i>做得好！继续练习以提高分数。</div>' :
                '<div class="alert alert-info"><i class="bi bi-arrow-repeat me-2"></i>继续练习！每次面试都会让你更强大。</div>'
              }
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                <i class="bi bi-arrow-left me-1"></i>开始新面试
              </button>
            </div>
          </div>
        </div>
      </div>`;
    
    // 移除任何现有的结果模态框
    document.getElementById('resultsModal')?.remove();
    
    // 将模态框添加到body
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    modal.show();
    
    // 关闭时清理
    document.getElementById('resultsModal').addEventListener('hidden.bs.modal', () => {
      document.getElementById('resultsModal').remove();
    });
  }

  // 绑定事件
  document.getElementById('start-interview').addEventListener('click', async () => {
    const chosen = Array.from(document.querySelectorAll('#challenge-checkboxes input[type="checkbox"]:checked')).map(c => c.value);
    const duration = parseInt(document.getElementById('interview-duration').value || '0', 10);
    if (chosen.length === 0) { alert('至少选择一个挑战。'); return; }
    if (duration <= 0) { alert('请输入有效时长。'); return; }
    initSession(chosen, duration);
    document.getElementById('setup').style.display = 'none';
    document.getElementById('interview-session').style.display = 'block';
    updateSessionMeta();
    renderChallengeList();
    startTimer(duration);
    
    // 平滑滚动到顶部以显示面试会话
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
    
    // 稍作延迟后自动打开第一个挑战
    const sorted = chosen.map(Number).sort((a,b) => a-b);
    if (sorted.length > 0) {
      setTimeout(async () => {
        await openChallenge(sorted[0]);
      }, 500);
    }
  });

  document.getElementById('finish-interview').addEventListener('click', () => {
    if (!currentSession) return;
    
    // 更新模态框内容以包含当前会话信息
    const remainingTime = Math.max(0, currentSession.startedAt + currentSession.duration * 60 * 1000 - Date.now());
    const minutes = Math.floor(remainingTime / 60000);
    const seconds = Math.floor((remainingTime % 60000) / 1000);
    document.getElementById('modal-time-remaining').textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    
    const attempted = Object.keys(currentSession.results).length;
    document.getElementById('modal-challenges-completed').textContent = `${attempted}/${currentSession.challengeIds.length}`;
    
    // 显示确认模态框
    const modal = new bootstrap.Modal(document.getElementById('finishInterviewModal'));
    modal.show();
  });
  
  document.getElementById('confirm-finish-interview').addEventListener('click', () => {
    // 关闭确认模态框
    bootstrap.Modal.getInstance(document.getElementById('finishInterviewModal')).hide();
    // 执行结束
    finishInterview();
  });
  document.getElementById('run-tests').addEventListener('click', runTestsForCurrent);
  document.getElementById('save-progress').addEventListener('click', saveProgress);
  document.getElementById('clear-history').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('clearHistoryModal'));
    modal.show();
  });
  
  document.getElementById('confirm-clear-history').addEventListener('click', () => {
    localStorage.removeItem(lsKeyHistory);
    renderHistory();
    bootstrap.Modal.getInstance(document.getElementById('clearHistoryModal')).hide();
  });

  // 上一题/下一题导航
  const prevBtn = document.getElementById('prev-question');
  const nextBtn = document.getElementById('next-question');
  function gotoRelative(delta) {
    if (!currentSession || !currentSession.challengeIds?.length) return;
    const ordered = [...currentSession.challengeIds].map(Number).sort((a,b)=>a-b);
    const currentId = Number(document.getElementById('challenge-id').textContent || ordered[0]);
    const idx = Math.max(0, ordered.indexOf(currentId));
    const nextIdx = Math.min(ordered.length-1, Math.max(0, idx + delta));
    const target = ordered[nextIdx];
    if (target && target !== currentId) {
      openChallenge(target);
    }
  }
  prevBtn.addEventListener('click', ()=>gotoRelative(-1));
  nextBtn.addEventListener('click', ()=>gotoRelative(1));

  // 步骤导航
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const toStep2 = document.getElementById('to-step-2');
  const backToStep1 = document.getElementById('back-to-step-1');

  function updateSelectedCount() {
    const count = document.querySelectorAll('#challenge-checkboxes input[type="checkbox"]:checked').length;
    document.getElementById('selected-count').textContent = count;
    toStep2.disabled = count === 0;
  }

  // 动态复选框渲染与过滤
  const checkboxContainer = document.getElementById('challenge-checkboxes');

  function renderCheckboxes(list) {
    const html = list.map(ch => {
      const difficultyIcon = ch.difficulty === 'beginner' ? 'bi-star' : ch.difficulty === 'intermediate' ? 'bi-star-fill' : 'bi-stars';
      return `
        <label class="list-group-item d-flex align-items-center gap-3 py-3 border-0 border-bottom" data-id="${ch.id}" data-difficulty="${ch.difficulty}" style="cursor: pointer;"> 
          <input class="form-check-input" type="checkbox" value="${ch.id}" ${selectedIds.has(String(ch.id)) || selectedIds.has(ch.id) ? 'checked' : ''}>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold text-primary">#${ch.id} - ${ch.title}</div>
              </div>
              <span class="badge ${ch.difficulty==='beginner'?'bg-success':(ch.difficulty==='intermediate'?'bg-warning':'bg-danger')} px-2 py-1">
                <i class="bi ${difficultyIcon} me-1"></i>${ch.difficulty.charAt(0).toUpperCase()+ch.difficulty.slice(1)}
              </span>
            </div>
          </div>
        </label>`;
    }).join('');
    checkboxContainer.innerHTML = html;
    // 绑定change事件
    checkboxContainer.querySelectorAll('input[type=\"checkbox\"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const id = e.target.value;
        if (e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
        updateSelectedCount();
      });
    });
  }

  function filteredChallenges() {
    const term = (document.getElementById('challenge-search')?.value || '').toLowerCase().trim();
    const normalizedTerm = term.replace(/\s+/g,'');
    const list = allChallenges.filter(ch => {
      const matchesDiff = (activeFilter==='all') || (ch.difficulty===activeFilter);
      const text = (`#${ch.id} ${ch.title}`).toLowerCase();
      const normalizedText = text.replace(/\s+/g,'');
      const matchesTerm = !term || text.includes(term) || normalizedText.includes(normalizedTerm);
      return matchesDiff && matchesTerm;
    });
    // 默认按ID升序排序
    list.sort((a,b) => a.id - b.id);
    return list;
  }

  function applyFiltersAndRender() {
    renderCheckboxes(filteredChallenges());
  }

  // 初始渲染
  applyFiltersAndRender();
  updateSelectedCount();

  toStep2.addEventListener('click', () => {
    step2.scrollIntoView({ behavior: 'smooth' });
  });
  backToStep1.addEventListener('click', () => {
    step1.scrollIntoView({ behavior: 'smooth' });
  });

  // 过滤和搜索控件
  const filterButtons = Array.from(step1.querySelectorAll('button[data-filter]'));
  const searchInput = document.getElementById('challenge-search');

  filterButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeFilter = (btn.getAttribute('data-filter') || 'all').toLowerCase();
      applyFiltersAndRender();
    });
  });
  searchInput.addEventListener('input', applyFiltersAndRender);

  // 处理侧边栏标签页样式
  const sidebarTabButtons = document.querySelectorAll('#sidebar-tabs .nav-link');
  sidebarTabButtons.forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (event) {
      // 移除所有标签页的激活样式
      sidebarTabButtons.forEach(t => {
        t.style.background = 'transparent';
        t.style.color = 'rgba(255,255,255,0.7)';
      });
      // 添加当前标签页的激活样式
      event.target.style.background = 'rgba(255,255,255,0.2)';
      event.target.style.color = 'white';
    });
  });

  renderHistory();

  // 帮助函数：转义HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // 帮助函数：获取当前挑战ID
  function getCurrentChallengeId() {
    if (!currentSession || !currentSession.challengeIds || currentSession.challengeIds.length === 0) {
      return null;
    }
    
    // 目前使用第一个挑战ID
    // 在更复杂的实现中，你可能会跟踪当前活跃的挑战
    return currentSession.challengeIds[0];
  }



  // AI功能
  window.requestAIReview = async function() {
    const currentCode = editor ? editor.getValue() : '';
    
    if (!currentCode.trim()) {
      alert('请先写一些代码！');
      return;
    }
    
    // 使用帮助函数获取当前挑战ID
    const currentChallengeId = getCurrentChallengeId();
    
    if (!currentChallengeId) {
      alert('请先开始面试会话并选择一个挑战！\n\n步骤：\n1. 从列表中选择挑战\n2. 设置时长\n3. 点击“开始面试”\n4. 开始在挑战上编码');
      return;
    }

    showAILoading('正在获取AI代码审查...');
    
    try {
      const response = await fetch('/api/ai/code-review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          challengeId: currentChallengeId,
          code: currentCode,
          context: `面试会话，${currentSession.challengeIds.length} 个挑战，已过去 ${Math.floor((Date.now() - currentSession.startedAt) / 60000)} 分钟`
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const review = await response.json();
      console.log('AI审查响应:', review);
      
      if (!review || typeof review !== 'object') {
        throw new Error('AI服务返回格式无效');
      }
      
      displayAIReview(review);
    } catch (error) {
      showAIError('获取AI审查失败: ' + error.message);
    }
  };

  window.requestInterviewQuestions = async function() {
    const currentCode = editor ? editor.getValue() : '';
    
    // 使用帮助函数获取当前挑战ID
    const currentChallengeId = getCurrentChallengeId();
    
    if (!currentChallengeId) {
      alert('请先开始面试会话并选择一个挑战！');
      return;
    }

    showAILoading('正在生成面试问题...');
    
    try {
      const response = await fetch('/api/ai/interviewer-questions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          challengeId: currentChallengeId,
          code: currentCode,
          userProgress: `第1个挑战，共${currentSession.challengeIds.length}个`
        })
      });
      
      const result = await response.json();
      console.log('AI问题响应:', result);
      
      // 处理数组和对象中的questions属性
      const questions = result.questions || result;
      displayInterviewQuestions(questions);
    } catch (error) {
      showAIError('获取面试问题失败: ' + error.message);
    }
  };

  window.requestHint = async function(level = 1) {
    const currentCode = editor ? editor.getValue() : '';
    
    // 使用帮助函数获取当前挑战ID
    const currentChallengeId = getCurrentChallengeId();
    
    if (!currentChallengeId) {
      alert('请先开始面试会话并选择一个挑战！');
      return;
    }

    showAILoading(`正在获取提示 (等级 ${level})...`);
    
    try {
      const response = await fetch('/api/ai/code-hint', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          challengeId: currentChallengeId,
          code: currentCode,
          hintLevel: level
        })
      });
      
      const result = await response.json();
      displayHint(result.hint, level);
    } catch (error) {
      showAIError('获取提示失败: ' + error.message);
    }
  };

  function showAILoading(message) {
    const responseArea = document.getElementById('ai-response-area');
    const title = document.getElementById('ai-response-title');
    const content = document.getElementById('ai-response-content');
    
    title.textContent = 'AI思考中...';
    content.innerHTML = `
      <div class="text-center">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
        ${message}
      </div>
    `;
    responseArea.style.display = 'block';
  }

  function displayAIReview(review) {
    const title = document.getElementById('ai-response-title');
    const content = document.getElementById('ai-response-content');
    
    // 提供缺失属性的默认值
    const overallScore = review.overall_score || 0;
    const readabilityScore = review.readability_score || 0;
    const interviewerFeedback = review.interviewer_feedback || '暂无反馈';
    
    title.textContent = `AI代码审查 (得分: ${overallScore}/100)`;
    
    let html = `
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="badge bg-${getScoreColor(overallScore)} fs-6">
            总体得分: ${overallScore}/100
          </div>
        </div>
        <div class="col-md-6">
          <div class="badge bg-info fs-6">
            可读性: ${readabilityScore}/100
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6><i class="bi bi-chat-quote-fill me-1"></i>面试官反馈:</h6>
        <div class="alert alert-light p-2 small">${escapeHtml(interviewerFeedback)}</div>
      </div>
    `;
    
    if (review.issues && Array.isArray(review.issues) && review.issues.length > 0) {
      html += `
        <div class="mb-3">
          <h6><i class="bi bi-exclamation-triangle me-1"></i>发现的问题:</h6>
          ${review.issues.map(issue => `
            <div class="alert alert-${getSeverityColor(issue.severity)} p-2 small mb-1">
              <strong>${escapeHtml(issue.type.toUpperCase())}:</strong> ${escapeHtml(issue.description)}
              ${issue.solution ? `<br><em>修复: ${escapeHtml(issue.solution)}</em>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }
    
    if (review.suggestions && Array.isArray(review.suggestions) && review.suggestions.length > 0) {
      html += `
        <div class="mb-3">
          <h6><i class="bi bi-lightbulb me-1"></i>建议:</h6>
          ${review.suggestions.map(suggestion => `
            <div class="alert alert-info p-2 small mb-1">
              <strong>${escapeHtml(suggestion.category)}:</strong> ${escapeHtml(suggestion.description)}
            </div>
          `).join('')}
        </div>
      `;
    }
    
    if (review.complexity) {
      html += `
        <div class="mb-3">
          <h6><i class="bi bi-speedometer me-1"></i>复杂度分析:</h6>
          <div class="row">
            <div class="col-6">
              <div class="badge bg-secondary">时间: ${review.complexity.time_complexity}</div>
            </div>
            <div class="col-6">
              <div class="badge bg-secondary">空间: ${review.complexity.space_complexity}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    content.innerHTML = html;
  }

  function displayInterviewQuestions(questions) {
    const title = document.getElementById('ai-response-title');
    const content = document.getElementById('ai-response-content');
    
    title.textContent = '面试问题';
    
    let html = `
      <div class="mb-2">
        <h6><i class="bi bi-person-check me-1"></i>面试官提问:</h6>
      </div>
    `;
    
    // 确保questions是数组
    if (questions && Array.isArray(questions)) {
      questions.forEach((question, index) => {
      html += `
        <div class="alert alert-primary p-2 small mb-2">
          <strong>Q${index + 1}:</strong> ${escapeHtml(question)}
        </div>
      `;
      });
    } else {
      html += `
        <div class="alert alert-warning p-2 small">
          当前没有可用的问题。
        </div>
      `;
    }
    
    content.innerHTML = html;
  }

  function displayHint(hint, level) {
    const title = document.getElementById('ai-response-title');
    const content = document.getElementById('ai-response-content');
    
    title.textContent = `提示 (等级 ${level}/4)`;
    
    // 确保hint是字符串
    const safeHint = hint || '当前没有可用的提示。';
    
    const nextLevelButton = level < 4 ? `
      <button class="btn btn-warning btn-sm mt-2" onclick="requestHint(${level + 1})">
        <i class="bi bi-lightbulb me-1"></i>需要更多帮助？(等级 ${level + 1})
      </button>
    ` : '';
    
    content.innerHTML = `
      <div class="alert alert-warning p-3">
        <i class="bi bi-lightbulb-fill me-2"></i>
        ${escapeHtml(safeHint)}
        ${nextLevelButton}
      </div>
    `;
  }

  function showAIError(message) {
    const title = document.getElementById('ai-response-title');
    const content = document.getElementById('ai-response-content');
    
    title.textContent = 'AI错误';
    content.innerHTML = `
      <div class="alert alert-danger p-2 small">
        <i class="bi bi-exclamation-triangle me-1"></i>
        ${message}
      </div>
    `;
  }

  function getScoreColor(score) {
    if (score >= 80) return 'success';
    if (score >= 60) return 'warning';
    return 'danger';
  }

  function getSeverityColor(severity) {
    switch (severity) {
      case 'critical': return 'danger';
      case 'high': return 'warning';
      case 'medium': return 'info';
      case 'low': return 'light';
      default: return 'secondary';
    }
  }
})();
</script>
{{end}}