{{define "content"}}
<!-- Hero Section -->
<div class="row mb-4">
    <div class="col">
        <div class="hero-section text-center py-4">
            <div class="hero-content">
                <h1 class="display-5 fw-bold mb-3">ğŸ† ä¸»æ’è¡Œæ¦œ</h1>
                <p class="lead mb-4">æŒ‰å®ŒæˆæŒ‘æˆ˜æ•°æ’åçš„é¡¶å°–å¼€å‘è€…</p>
                
                <div class="d-flex justify-content-center flex-wrap gap-2 mb-3">
                    <button id="refresh-leaderboard" class="btn btn-light px-4">
                        <i class="bi bi-arrow-clockwise me-2"></i>åˆ·æ–°æ’è¡Œæ¦œ
                    </button>
                    <a href="/" class="btn btn-outline-light px-4">
                        <i class="bi bi-code-slash me-2"></i>æµè§ˆæŒ‘æˆ˜
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½çŠ¶æ€ -->
<div id="loading-state" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...</span>
    </div>
    <p class="text-muted">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</p>
</div>

<!-- æ’è¡Œæ¦œå†…å®¹ -->
<div id="leaderboard-content" style="display: none;">
    <!-- å‰ä¸‰åå¥–å° -->
    <div class="row mb-5" id="podium-section" style="display: none;">
        <div class="col">
            <h3 class="text-center mb-4">ğŸ¥‡ å† å†›æ¦œ</h3>
            <div class="row justify-content-center">
                <!-- å‰ä¸‰åå°†ç”± JavaScript åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- å®Œæ•´æ’è¡Œæ¦œ -->
    <div class="row">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy me-2"></i>å®Œæ•´æ’å
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="leaderboard-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 80px;">æ’å</th>
                                    <th style="width: 200px;">å¼€å‘è€…</th>
                                    <th class="text-center" style="width: 120px;">å·²è§£å†³</th>
                                    <th class="text-center" style="width: 120px;">å®Œæˆç‡</th>
                                    <th class="text-center" style="width: 150px;">æˆå°±</th>
                                    <th>æŒ‘æˆ˜è¿›åº¦</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-tbody">
                                <!-- æ’è¡Œæ¦œè¡Œå°†ç”± JavaScript å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æŒ‘æˆ˜å›¾ä¾‹ -->
<div class="row mt-4" id="legend-section" style="display: none;">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-info-circle me-2"></i>æŒ‘æˆ˜è¿›åº¦å›¾ä¾‹
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2">âœ“</span>
                            å·²å®Œæˆï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-flex align-items-center mb-2">
                            <span class="badge bg-light text-dark me-2">â€¢</span>
                            æœªå°è¯•æˆ–æœªå®Œæˆ
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    margin-bottom: 2rem;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="white" opacity="0.1"/></svg>') repeat;
    background-size: 40px 40px;
}

.hero-content {
    position: relative;
    z-index: 2;
}

.podium-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: none;
    border-radius: 15px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.podium-card.first {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    transform: scale(1.05);
    box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
}

.podium-card.second {
    background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
    box-shadow: 0 8px 25px rgba(192, 192, 192, 0.3);
}

.podium-card.third {
    background: linear-gradient(135deg, #cd7f32, #daa520);
    box-shadow: 0 8px 25px rgba(205, 127, 50, 0.3);
}

.podium-rank {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.podium-rank.first {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
}

.podium-rank.second {
    background: linear-gradient(135deg, #4ecdc4, #45b7aa);
}

.podium-rank.third {
    background: linear-gradient(135deg, #feca57, #ff6348);
}

.challenge-indicator {
    display: inline-block;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    margin: 1px;
    text-align: center;
    line-height: 22px;
    font-size: 0.7rem;
    font-weight: bold;
    transition: all 0.2s ease;
}

.challenge-indicator.completed {
    background: #28a745;
    color: white;
}

.challenge-indicator.not-completed {
    background: #e9ecef;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.challenge-indicator:hover {
    transform: scale(1.1);
    z-index: 10;
    position: relative;
}

.rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 0.9rem;
}

.rank-badge.top-1 {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #333;
}

.rank-badge.top-3 {
    background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
    color: #333;
}

.rank-badge.top-10 {
    background: linear-gradient(135deg, #cd7f32, #daa520);
}

.rank-badge.other {
    background: linear-gradient(135deg, #6c757d, #495057);
}

.avatar-small {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.achievement-badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    font-weight: 500;
}
</style>
{{end}}

{{define "scripts"}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingState = document.getElementById('loading-state');
    const leaderboardContent = document.getElementById('leaderboard-content');
    const podiumSection = document.getElementById('podium-section');
    const legendSection = document.getElementById('legend-section');
    const leaderboardTbody = document.getElementById('leaderboard-tbody');
    const refreshButton = document.getElementById('refresh-leaderboard');

    // åŠ è½½æ’è¡Œæ¦œæ•°æ®
    async function loadLeaderboard() {
        try {
            loadingState.style.display = 'block';
            leaderboardContent.style.display = 'none';

            const response = await fetch('/api/main-leaderboard');
            const data = await response.json();

            if (data.success && data.leaderboard.length > 0) {
                renderLeaderboard(data.leaderboard);
                loadingState.style.display = 'none';
                leaderboardContent.style.display = 'block';
                legendSection.style.display = 'block';
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('åŠ è½½æ’è¡Œæ¦œæ—¶å‡ºé”™:', error);
            showErrorState();
        }
    }

    function renderLeaderboard(leaderboard) {
        // æ˜¾ç¤ºå‰ä¸‰åå¥–å°
        if (leaderboard.length >= 3) {
            renderPodium(leaderboard.slice(0, 3));
            podiumSection.style.display = 'block';
        }

        // æ¸²æŸ“å®Œæ•´è¡¨æ ¼
        leaderboardTbody.innerHTML = '';
        leaderboard.forEach(user => {
            const row = createLeaderboardRow(user);
            leaderboardTbody.appendChild(row);
        });
    }

    function renderPodium(topThree) {
        const podiumContainer = podiumSection.querySelector('.row');
        podiumContainer.innerHTML = '';

        // é‡æ–°æ’åºä»¥å®ç°å¥–å°è§†è§‰æ•ˆæœï¼šç¬¬äºŒåã€ç¬¬ä¸€åã€ç¬¬ä¸‰å
        const podiumOrder = [topThree[1], topThree[0], topThree[2]].filter(Boolean);
        
        podiumOrder.forEach((user, index) => {
            if (!user) return;
            
            const actualRank = user.rank;
            const podiumClass = actualRank === 1 ? 'first' : actualRank === 2 ? 'second' : 'third';
            const rankClass = actualRank === 1 ? 'first' : actualRank === 2 ? 'second' : 'third';
            
            const podiumCard = document.createElement('div');
            podiumCard.className = `col-md-4 mb-3`;
            podiumCard.innerHTML = `
                <div class="card podium-card ${podiumClass} text-center p-3">
                    <div class="podium-rank ${rankClass}">${actualRank}</div>
                    <img src="https://github.com/${user.username}.png" 
                         class="rounded-circle mx-auto mb-3" 
                         style="width: 80px; height: 80px; border: 3px solid white;">
                    <h5 class="mb-2">${user.username}</h5>
                    <p class="mb-2"><strong>${user.completedCount}</strong> ä¸ªæŒ‘æˆ˜å·²è§£å†³</p>
                    <p class="mb-0 small">${user.completionRate.toFixed(1)}% å®Œæˆç‡</p>
                    <div class="mt-2">
                        <span class="badge bg-primary achievement-badge">${user.achievement}</span>
                    </div>
                </div>
            `;
            podiumContainer.appendChild(podiumCard);
        });
    }

    function createLeaderboardRow(user) {
        const row = document.createElement('tr');
        
        // æ’åå¾½ç« æ ·å¼
        let rankBadgeClass = 'other';
        if (user.rank === 1) rankBadgeClass = 'top-1';
        else if (user.rank <= 3) rankBadgeClass = 'top-3';
        else if (user.rank <= 10) rankBadgeClass = 'top-10';

        // ç”ŸæˆæŒ‘æˆ˜æŒ‡ç¤ºå™¨ï¼ˆå‡è®¾å­˜åœ¨ 1-28 å·æŒ‘æˆ˜ï¼‰
        let challengeIndicators = '';
        for (let i = 1; i <= 28; i++) {
            const isCompleted = user.completedChallenges[i] === true;
            const indicatorClass = isCompleted ? 'completed' : 'not-completed';
            const content = isCompleted ? 'âœ“' : 'â€¢';
            challengeIndicators += `<span class="challenge-indicator ${indicatorClass}" title="æŒ‘æˆ˜ ${i}: ${isCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}">${content}</span>`;
        }

        row.innerHTML = `
            <td class="text-center">
                <div class="rank-badge ${rankBadgeClass}">${user.rank}</div>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <img src="https://github.com/${user.username}.png" 
                         class="avatar-small me-3" alt="${user.username}">
                    <div>
                        <div class="fw-bold">${user.username}</div>
                        <a href="https://github.com/${user.username}" target="_blank" 
                           class="small text-muted text-decoration-none">
                            <i class="bi bi-github"></i> æŸ¥çœ‹èµ„æ–™
                        </a>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <div class="fw-bold text-primary fs-5">${user.completedCount}</div>
                <small class="text-muted">ä¸ªæŒ‘æˆ˜</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-success">${user.completionRate.toFixed(1)}%</div>
                <small class="text-muted">å®Œæˆ</small>
            </td>
            <td class="text-center">
                <span class="badge bg-primary achievement-badge">${user.achievement}</span>
            </td>
            <td>
                <div style="line-height: 1.2;">
                    ${challengeIndicators}
                </div>
            </td>
        `;

        return row;
    }

    function showEmptyState() {
        loadingState.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-trophy" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="mt-3 text-muted">æš‚æ— æ’å</h4>
                <p class="text-muted">æˆä¸ºç¬¬ä¸€ä¸ªå®ŒæˆæŒ‘æˆ˜çš„äººï¼Œäº‰å¤ºæ¦œé¦–ï¼</p>
                <a href="/" class="btn btn-primary">æµè§ˆæŒ‘æˆ˜</a>
            </div>
        `;
    }

    function showErrorState() {
        loadingState.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                <h4 class="mt-3 text-danger">åŠ è½½æ’è¡Œæ¦œå¤±è´¥</h4>
                <p class="text-muted">æ— æ³•åŠ è½½æ’è¡Œæ¦œæ•°æ®ã€‚è¯·é‡è¯•ã€‚</p>
                <button class="btn btn-primary" onclick="location.reload()">é‡è¯•</button>
            </div>
        `;
    }

    // åˆ·æ–°æŒ‰é’®å¤„ç†
    refreshButton.addEventListener('click', loadLeaderboard);

    // åˆå§‹åŠ è½½
    loadLeaderboard();
});
</script>
{{end}}